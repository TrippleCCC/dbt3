#!/bin/sh
#
# This file is released under the terms of the Artistic License.
# Please see the file LICENSE, included in this package, for details.
#
# Copyright (C) 2014      Mark Wong
#               2014      2ndQuadrant, Ltd.

POWER_TEST=0
THROUGHPUT_TEST=0

usage()
{
	echo "usage: `basename $0` [-23hz] [-i q_time.csv] [-o directory]"
	echo " 2 - power test data"
	echo " 3 - throughput test data"
	echo " i - query time csv data file"
	echo " o - output directory to save bar charts"
	echo " z - no refresh stream data"
}

OUTDIR="."
POWER_TEST=0
THROUGHPUT_TEST=0
while getopts "23hi:o:z" opt; do
	case $opt in
	2)
		POWER_TEST=1
		;;
	3)
		THROUGHPUT_TEST=1
		;;
	h)
		usage
		exit 0
		;;
	i)
		INFILE=${OPTARG}
		;;
	o)
		OUTDIR=${OPTARG}
		;;
	z)
		NO_REFRESH_FLAG="-z"
		;;
	esac
done

R --slave --no-save << __EOF__
df <- read.csv("${INFILE}", header=T)

count <- 0
labels <- NULL

df\$q <- NA
df\$task <- NA

df_plot <- df[0, ]

if (${POWER_TEST} == 1) {
  count <- count + 1
  labels <- c(labels, "Performance")

  for (i in 1:22) {
    df[df\$task_name == paste("PERF1.POWER.Q", i, sep=""), ]\$q = i
  }

  df_power <- df[grep("PERF1.POWER.Q", df\$task_name), ]
  df_power <- df_power[with(df_power, order(q)), ]
  df_power\$task = "Performance Test"

  df_plot <- rbind(df_plot, df_power)
}

if (${THROUGHPUT_TEST} == 1) {
  df_thruput <- df[grep("*.THRUPUT.QS.*.ALL", df\$task_name), ]
  runs <- nrow(df_thruput)

  if (runs > 0) {
    for (i in 1:runs) {
      count <- count + 1
      labels <- c(labels, paste("Throughput", i))

      for (j in 1:22) {
        str <- paste("PERF1.THRUPUT.QS", i, ".Q", j, sep="")
        df[df\$task_name == str, ]\$q = j
      }

      str <- paste("PERF1.THRUPUT.QS", i, ".Q", sep="")
      df_thruput <- df[grep(str, df\$task_name), ]
      df_thruput <- df_thruput[with(df_thruput, order(q)), ]
      df_thruput\$task = paste("Throughput Test", i)

      df_plot <- rbind(df_plot, df_thruput)
    }
  }
}

data <- matrix(df_plot\$seconds, ncol=22, byrow=T)

colors <- cm.colors(count)
df_plot <- df_plot[with(df_plot, order(q, task_name)), ]
bitmap("${OUTDIR}/q_time.png", type="png16m", units="px",
       width=1437, height=888, res=150, taa=4, gaa=4)
barplot(data, names.arg=df_plot\$q, col=colors, beside=T,
        main="Query Execution Time", xlab="Query", ylab="Seconds")
legend("topright", legend=labels, fil=colors, bty="n")
grid(col="gray")
invisible(dev.off())
__EOF__
