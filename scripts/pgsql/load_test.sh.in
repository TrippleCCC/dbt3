#!/bin/sh
#
# load_test.sh.in
#
# This file is released under the terms of the Artistic License.  Please see
# the file LICENSE, included in this package, for details.
#
# Copyright (C) 2002 Jenny Zhang & Open Source Development Lab, Inc.
#
# 15 July 2004 - Revamped by Mark Wong

# this script is used to build the database
# ./build_db.sh -g <scale_factor> will generate data and build the database
# ./build_db.sh will load the database from previously generated data files

SRCDIR=@TOPDIR@

DBSCRIPTDIR=$SRCDIR/scripts/pgsql

GTIME="$SRCDIR/dbdriver/utils/gtime"

clearprof () {
	sudo /usr/sbin/readprofile -m /boot/System.map -r
}

getprof () {
        mkdir -p $OUTPUT_DIR/prof
	sudo /usr/sbin/readprofile -n -m /boot/System.map -v | sort -grk3,4 > $OUTPUT_DIR/prof/${profname}.prof
}

clearoprof () {
	sudo opcontrol --vmlinux=/boot/vmlinux
	sleep 2
	sudo opcontrol --start-daemon
	sleep 2
	sudo opcontrol --start
	sleep 2
	# If opcontrol ever gets stuck here, sometimes it helps to remove
	# everything in this dir:
	# /var/lib/oprofile
	sudo opcontrol --reset
}

getoprof () {
	mkdir -p $OUTPUT_DIR/oprofile/${profname}/annotate
	sudo opcontrol --dump
	sudo opreport -l -o $OUTPUT_DIR/oprofile/${profname}/oprofile.txt
	sudo opcontrol --stop
	cp -pR /var/lib/oprofile/samples/current $OUTPUT_DIR/oprofile/${profname}/
	sudo opannotate --source --assembly > $OUTPUT_DIR/oprofile/${profname}/assembly.txt 2>&1
	sudo opannotate --source --output-dir=$OUTPUT_DIR/oprofile/${profname}/annotate
	sudo opstack > $OUTPUT_DIR/oprofile/${profname}/call-graph.txt
}

db_param=""
SF=0
redirect_tmp=0
redirect_xlog=0
USE_OPROFILE=0
GENERATE=0

while getopts "f:g:o:p:r:x:y:" opt; do
	case $opt in
	f)
		SF=$OPTARG
		;;
	g)
		GENERATE=$OPTARG
		;;
	o)
		OUTPUT_DIR=$OPTARG
		;;
	p)
		db_param=$OPTARG
		;;
	r)
		redirect_tmp=$OPTARG
		;;
	x)
		redirect_xlog=$OPTARG
		;;
	y)
		USE_OPROFILE=$OPTARG
		;;
	?)
		echo "Usage: $0 [ -o <dir> -p <db_param> -f <scale_factor> -r <0/1> -x <0/1> -y <0/1>]"
		exit 1
	esac
done

if [ $GENERATE -ne 0 ]; then
	echo "Generating data... scale factor $SF"
	cd $SRCDIR/datagen/dbgen
	date
	$SRCDIR/datagen/dbgen/dbgen -s $SF
	echo "data files are generated"
	date
	cd $SRCDIR/scripts/pgsql
else
	echo "build the database without generating the data files"
fi

# Initialize profile counters.
if [ -f /proc/profile ]; then
	clearprof
fi

if [ $USE_OPROFILE -eq 1 ]; then
	clearoprof
fi

# Start collecting system statistics.
bash $SRCDIR/scripts/start_sysstats.sh -o $OUTPUT_DIR -p load

echo "Create database"
bash -x $SRCDIR/scripts/pgsql/create_db.sh "$db_param"
echo
	
echo "Create tables"
bash -x $SRCDIR/scripts/pgsql/create_tables.sh
echo

echo "`date +'%Y-%m-%d %H:%M:%S'` start load test"
s_time=`$GTIME`
bash $DBSCRIPTDIR/record_start.sh -n "LOAD"

# Handle moving the temp space.
if [ $redirect_tmp -eq 1 ]
then 
	bash -x $SRCDIR/scripts/pgsql/stop_db.sh
	echo "create symbolic links for pgsql_tmp"
	rm -rf /db_tmp/*
	bash -x $SRCDIR/scripts/pgsql/ln_pgsql_tmp.sh
	bash -x $SRCDIR/scripts/pgsql/start_db.sh "$db_param"
fi

# Handle moving the database log.
if [ $redirect_xlog -eq 1 ]
then 
	bash -x $SRCDIR/scripts/pgsql/stop_db.sh
	echo "create symbolic links for pgsql_xlog"
	rm -rf /db_xlog/*
	ln -s /db_xlog $PGDATA/pg_xlog_tmp
	sudo chmod 777 $PGDATA/pg_xlog_tmp
	mv $PGDATA/pg_xlog/* $PGDATA/pg_xlog_tmp/
	rm -rf $PGDATA/pg_xlog
	mv $PGDATA/pg_xlog_tmp $PGDATA/pg_xlog
	bash -x $SRCDIR/scripts/pgsql/start_db.sh "$db_param"
fi

date
echo "Load database"
bash -x $SRCDIR/scripts/pgsql/load_db.sh
date
	
date
echo "Create indexes"
bash -x $SRCDIR/scripts/pgsql/create_indexes.sh
date
	
date
echo "Update optimizer statistics"
bash -x $SRCDIR/scripts/pgsql/update_statistics.sh
date

bash $DBSCRIPTDIR/record_end.sh -n "LOAD"
e_time=`$GTIME`
echo "`date +'%Y-%m-%d %H:%M:%S'` load test end"
let "diff_time=$e_time-$s_time"
echo "elapsed time for load test ${i} $diff_time"

# Stop collecting system statistics.
bash $SRCDIR/scripts/stop_sysstats.sh

# Collect profile data.
if [ -f /proc/profile ]; then
	profname='Load_Test'
	getprof
fi

if [ $USE_OPROFILE -eq 1 ]; then
	profname='Load_Test'
	getoprof
fi
