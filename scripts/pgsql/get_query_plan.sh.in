#!/bin/sh
#
# get_query_plan.sh
#
# This file is released under the terms of the Artistic License.  Please see
# the file LICENSE, included in this package, for details.
#
# Copyright (C) 2003 Open Source Development Lab, Inc.
#
# History: June-16-2003 Created by Jenny Zhang
#
# 22 September 2004: Renamed from explain_single_query.sh.in since the file
#                    description didn't really match what the scripts was
#                    really doing.
#                    Mark Wong

SRCDIR=@TOPDIR@

if [ $# -lt 4 ]; then
        echo "Usage: $0 <scale_factor> <query_name> <output_file> <run dir>"
        exit
fi

scale_factor=$1
query_name=$2
output_file=$3
RUNDIR=$4
GTIME="$SRCDIR/dbdriver/utils/gtime"

qgen_dir="$SRCDIR/datagen/dbgen"
seed_file="$RUNDIR/seed"
query_file="$RUNDIR/$query_name.sql"
tmp_query_file="$RUNDIR/tmp_$query_name.sql"
param_file="$RUNDIR/$query_name.param"
parsequery_pgsql_dir="$SRCDIR/dbdriver/utils"

if [ ! -f $seed_file ];
then
        echo "creating seed file $seed_file, you can change the seed by "
	echo "modifying this file"
	$SRCDIR/scripts/init_seed.sh > $seed_file
fi

# Generate the queries with EXPLAIN to get plans.
rm -f $query_file
$qgen_dir/qgen -c -r `cat $seed_file` -s $scale_factor -l $param_file $query_name -x > $query_file

# modify $query_file so that the commands are in one line
$parsequery_pgsql_dir/parse_query $query_file $tmp_query_file E

# Run the queries and save the output.
# You can't use -a and have the query redirected to a file with -o, so use -a
# and redirect.
@PSQL@ $SID -f $tmp_query_file -a >> $output_file 2>&1
