#!/bin/sh
#this script is used to build the database
# ./build_db.sh -g <scale_factor> will generate data and build the database
# ./build_db.sh will load the database from previously generated data files
set -x

#if [ $# -lt 1 ]; then
#	echo "usage: $0 <db_param> [-g <scale_factor>]"
#	exit 1
#fi
db_param=$1
shift 1

data_file=0
redirect_tmp=0
redirect_xlog=0
# if with -g, generate data file
while getopts "r:x:g:" opt; do
	case $opt in
		r) redirect_tmp=$OPTARG
			;;
		x) redirect_xlog=$OPTARG
			;;
		g) SF=$OPTARG
		   $data_file=1;
			;;
		?) echo "Usage: $0 <db_param> [-g <scale_factor> -r <redirect_tmp> -x <redirect_xlog>]"
			exit 1
	esac
done

if [ $data_file -eq 1 ]; then
	echo "Generating data... scale factor $SF"
	cd @TOPDIR@/datagen/dbgen
	date
	@TOPDIR@/datagen/dbgen/dbgen -s $SF
	echo "data files are generated"
	date
	cd @TOPDIR@/scripts/pgsql
else
	echo "build the database without generating the data files"
fi
	echo "drop db"
	@TOPDIR@/scripts/pgsql/drop_db.sh
	rm -rf $PGDATA/$SID
	echo
	
	echo "create db"
	@TOPDIR@/scripts/pgsql/create_db.sh "$db_param"
	echo
	
	echo "create tables"
	@TOPDIR@/scripts/pgsql/create_tables.sh
	echo

	if [ $redirect_tmp -eq 1 ]
	then 
		@TOPDIR@/scripts/pgsql/stop_db.sh
		echo "create symbolic links for pgsql_tmp"
		rm -rf /db_tmp/*
		@TOPDIR@/scripts/pgsql/ln_pgsql_tmp.sh
		@TOPDIR@/scripts/pgsql/start_db.sh "$db_param"
	fi
	#not sure if I can just remove everything
	if [ $redirect_xlog -eq 1 ]
	then 
		@TOPDIR@/scripts/pgsql/stop_db.sh
		echo "create symbolic links for pgsql_xlog"
		rm -rf /db_xlog/*
		ln -s /db_xlog $PGDATA/pg_xlog_tmp
		mv $PGDATA/pg_xlog/* $PGDATA/pg_xlog_tmp
		rm -rf $PGDATA/pg_xlog
		mv $PGDATA/pg_xlog_tmp $PGDATA/pg_xlog
		@TOPDIR@/scripts/pgsql/start_db.sh "$db_param"
	fi

	date
	echo "start loading db"
	@TOPDIR@/scripts/pgsql/load_db.sh
	date
	echo "loading db done"
	
	echo "starting to create indexes"
	date
	
	date
	echo "start creating indexes"
	@TOPDIR@/scripts/pgsql/create_indexes.sh
	date
	echo "creating indexes done"
	
	#date
	#echo "grant right to dbt"
	#@TOPDIR@/scripts/pgsql/grant.sh
	#date
	#echo "granting done"
	
	date
	echo "start updating optimizer statistics"
	@TOPDIR@/scripts/pgsql/update_statistics.sh
	date
	echo "updating optimizer statistics done"
	
	#date
	#echo "start backup database"
	#@TOPDIR@/scripts/pgsql/backup_db.sh
	#date
	#echo "backup done"
	
	date
