#!/bin/sh

# throughput_test_stats.sh: run throuput test and collect database and system 
# statistics
#
# This file is released under the terms of the Artistic License.  Please see
# the file LICENSE, included in this package, for details.
#
# Copyright (C) 2003 Open Source Development Lab, Inc.
#
# History: June-16-2003 Jenny Zhang

set -x

if [ $# -lt 3 ]; then
        echo "usage: throughput_test_stats.sh <scale_factor> <num_stream> <output_dir> [-s seed -d duration -i interval]"
        exit
fi

scale_factor=$1
num_stream=$2
output_dir=$3

#estimated power test time

throughput_test_time=6000

duration=0
interval=0
seed=0
shift 3
# process the command line parameters
while getopts ":d:i:" opt; do
	case $opt in
		s) seed=$OPTARG
				;;
		d) duration=$OPTARG
				;;
		i) interval=$OPTARG
				;;
		?) echo "Usage: $0 <scale_factor> <num_stream> [-s seed -d duration -i interval]"
			exit ;;
		esac
done

#if not specified, then use default value
if [ $interval -eq 0 ] 
then 
	interval=60
fi

if [ $duration -eq 0 ] 
then 
	duration=$throughput_test_time
fi

#if interval is larger than duration, then reduce interval by half
while [ $interval -gt $duration ]
do
	let "interval = $interval/2"
done

pgsql_script_path=@TOPDIR@/scripts/pgsql
dbdriver_pgsql_path=@TOPDIR@/dbdriver/scripts/pgsql
datacollect_path=@TOPDIR@/data_collect
datacollect_pgsql_path=@TOPDIR@/data_collect/pgsql
run_path=@TOPDIR@/run

#set run environment
. @TOPDIR@/scripts/pgsql/set_run_env.sh

if [ $seed -eq 0 ]; then
	echo "running throughput query with default seed"
	echo "`date`: generate seed0"
	echo "seed file is $seed_file";
	@TOPDIR@/dbdriver/scripts/init_seed.sh > $seed_file
else
        echo "running power test with seed $seed"
        echo "seed file is $seed_file";
        echo "$seed" > $seed_file
fi

#make output directory
mkdir -p $output_dir

#clean time_statistics table
psql -d $SID -U $PGUSER -c "delete from time_statistics;"
# restart the database
echo "stopping the database"
$pgsql_script_path/stop_db.sh
echo "starting the database"
$pgsql_script_path/start_db.sh

#get run configuration
$datacollect_pgsql_path/get_config.sh $scale_factor $num_stream $output_dir

#get meminfo
cat /proc/meminfo > $output_dir/meminfo0.out
sleep 2

#start sys_stats.sh
$datacollect_path/sys_stats.sh $interval $duration $output_dir &

#calculate count
let "count=$duration/$interval"
if [ $count -eq 0 ]
then
        count=1
fi

#get one more count
let "count=$count+1"
#get database statistics
$datacollect_pgsql_path/db_stats.sh $SID $output_dir $count $interval &

#execute the query
echo "run throughput query for scale factor $scale_factor perf_run_number 1 $num_stream streams"
#start the streams
i=1
while [ $i -le $num_stream ]
do
        echo "start throughput query of stream $i"
        $dbdriver_pgsql_path/run_throughput_query.sh $scale_factor 1 $i> $run_path/thuput_qs$i 2>&1 &
        let "i=$i+1"
done

# wait for the querys to finish
i=1
while [ $i -le $num_stream ]
do
	pid=`cat $run_path/PID$i`
	wait $pid
        let "i=$i+1"
done

#get meminfo
cat /proc/meminfo > $output_dir/meminfo1.out

#get query time
$datacollect_pgsql_path/q_time.sh $output_dir

#copy thuput_qs* and refresh_stream* to output
cp $run_path/thuput_qs* $output_dir/
cp $run_path/thuput_qs*.result $output_dir/
cp $run_path/tmp_throughput_query*.sql $output_dir/
cp $run_path/*param* $output_dir/


mv $datacollect_pgsql_path/thuput_query.out $output_dir/

ps -ef | grep -v grep | grep sar | awk '{print $2}' | xargs kill -9
ps -ef | grep -v grep | grep iostat | awk '{print $2}' | xargs kill -9
ps -ef | grep -v grep | grep vmstat | awk '{print $2}' | xargs kill -9
pgrep db_stats.sh | xargs kill -9
